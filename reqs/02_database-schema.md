# Database Schema

Documents the SQLite database structure including tables, columns, indexes, and node type relationships.

## $REQ_DB_001: Nodes Table Structure
**Source:** ./specs/DB-SCHEMA.md (Section: "Tables")

The database must have a `nodes` table with columns: `id` (INTEGER PRIMARY KEY), `parent_id` (INTEGER referencing nodes), `node_type` (TEXT NOT NULL), `doc_path` (TEXT), `dir_path` (TEXT), `content` (TEXT NOT NULL), and `embedding` (BLOB NOT NULL).

## $REQ_DB_002: Node Type Values
**Source:** ./specs/DB-SCHEMA.md (Section: "Tables")

The `node_type` column must accept only these values: 'chunk', 'summary', 'doc_top', 'dir_top', 'root'.

## $REQ_DB_003: Chunk Node Path Storage
**Source:** ./specs/DB-SCHEMA.md (Section: "Path Storage Rules")

Nodes of type 'chunk' must have `doc_path` set to the canonical PDF path and `dir_path` set to NULL.

## $REQ_DB_004: Summary Node Path Storage
**Source:** ./specs/DB-SCHEMA.md (Section: "Path Storage Rules")

Nodes of type 'summary' must have `doc_path` set to the canonical PDF path and `dir_path` set to NULL.

## $REQ_DB_005: Doc Top Node Path Storage
**Source:** ./specs/DB-SCHEMA.md (Section: "Path Storage Rules")

Nodes of type 'doc_top' must have `doc_path` set to the canonical PDF path and `dir_path` set to NULL.

## $REQ_DB_006: Dir Top Node Path Storage
**Source:** ./specs/DB-SCHEMA.md (Section: "Path Storage Rules")

Nodes of type 'dir_top' must have `doc_path` set to NULL and `dir_path` set to the canonical directory path.

## $REQ_DB_007: Root Node Path Storage
**Source:** ./specs/DB-SCHEMA.md (Section: "Path Storage Rules")

Nodes of type 'root' must have both `doc_path` and `dir_path` set to NULL.

## $REQ_DB_008: Embedding Format
**Source:** ./specs/DB-SCHEMA.md (Section: "Tables")

The `embedding` column must store 1536 float32 values (6144 bytes) generated by the text-embedding-3-small model.

## $REQ_DB_009: Directories Table Structure
**Source:** ./specs/DB-SCHEMA.md (Section: "Tables")

The database must have a `directories` table with columns: `id` (INTEGER PRIMARY KEY) and `path` (TEXT NOT NULL UNIQUE).

## $REQ_DB_010: Documents Table Structure
**Source:** ./specs/DB-SCHEMA.md (Section: "Tables")

The database must have a `documents` table with columns: `id` (INTEGER PRIMARY KEY), `directory_id` (INTEGER referencing directories), `path` (TEXT NOT NULL UNIQUE), and `filename` (TEXT NOT NULL).

## $REQ_DB_011: Node Doc Path Index
**Source:** ./specs/DB-SCHEMA.md (Section: "Indexes")

An index must exist on `nodes(doc_path, node_type)`.

## $REQ_DB_012: Node Dir Path Index
**Source:** ./specs/DB-SCHEMA.md (Section: "Indexes")

An index must exist on `nodes(dir_path, node_type)`.

## $REQ_DB_013: Node Type Index
**Source:** ./specs/DB-SCHEMA.md (Section: "Indexes")

An index must exist on `nodes(node_type)`.

## $REQ_DB_014: Node Parent Index
**Source:** ./specs/DB-SCHEMA.md (Section: "Indexes")

An index must exist on `nodes(parent_id)`.

## $REQ_DB_015: Document Summary Query
**Source:** ./specs/DB-SCHEMA.md (Section: "Query Patterns")

A document's summary must be retrievable by querying nodes where `doc_path` matches the canonical PDF path and `node_type` equals 'doc_top'.

## $REQ_DB_016: Directory Summary Query
**Source:** ./specs/DB-SCHEMA.md (Section: "Query Patterns")

A directory's summary must be retrievable by querying nodes where `dir_path` matches the canonical directory path and `node_type` equals 'dir_top'.

## $REQ_DB_017: Corpus Summary Query
**Source:** ./specs/DB-SCHEMA.md (Section: "Query Patterns")

The corpus summary must be retrievable by querying nodes where `node_type` equals 'root'.

## $REQ_DB_018: Path Existence Check via Documents Table
**Source:** ./specs/DB-SCHEMA.md (Section: "Query Patterns")

Document path existence must be verifiable by querying the `documents` table with the canonical path.

## $REQ_DB_019: Path Existence Check via Directories Table
**Source:** ./specs/DB-SCHEMA.md (Section: "Query Patterns")

Directory path existence must be verifiable by querying the `directories` table with the canonical path.

## $REQ_DB_020: K-NN Search Across Chunks
**Source:** ./specs/DB-SCHEMA.md (Section: "Query Patterns")

K-nearest-neighbor search must be supported across all chunk nodes using `vec_distance(embedding, :query_vec)` with filtering by `node_type = 'chunk'`.

## $REQ_DB_021: K-NN Search Within Document
**Source:** ./specs/DB-SCHEMA.md (Section: "Query Patterns")

K-nearest-neighbor search must be supported within a single document by filtering on `doc_path` and using `vec_distance()`.

## $REQ_DB_022: SQLite Vector Bundled
**Source:** ./specs/DB-SCHEMA.md (Section: "SQLite Vector")

SQLite and the SQLite Vector extension must be bundled into the executable with no external downloads or setup required.

## $REQ_DB_023: Path Canonicalization Before Storage
**Source:** ./specs/DB-SCHEMA.md (Section: "Path Canonicalization")

All paths must be canonicalized before storing in the database.

## $REQ_DB_024: Path Canonicalization Before Query
**Source:** ./specs/DB-SCHEMA.md (Section: "Path Canonicalization")

All paths must be canonicalized before querying the database, ensuring matches regardless of how the user specifies the path.

## $REQ_DB_025: Canonicalization Resolves to Absolute Path
**Source:** ./specs/DB-SCHEMA.md (Section: "Canonicalization Rules")

Path canonicalization must resolve relative paths, `.`, and `..` to absolute paths.

## $REQ_DB_026: Canonicalization Uses Forward Slashes
**Source:** ./specs/DB-SCHEMA.md (Section: "Canonicalization Rules")

Path canonicalization must convert backslashes to forward slashes.

## $REQ_DB_027: Canonicalization Removes Trailing Slashes
**Source:** ./specs/DB-SCHEMA.md (Section: "Canonicalization Rules")

Path canonicalization must remove trailing slashes from directories.

## $REQ_DB_028: Canonicalization Case Handling
**Source:** ./specs/DB-SCHEMA.md (Section: "Canonicalization Rules")

Path canonicalization must use lowercase on Windows and preserve original casing on Linux.
